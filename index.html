<!DOCTYPE html>
<html>
<head>
	<title></title>

	<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

	<script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
	<script src="https://sdk-cdn.mypurecloud.com/javascript/0.84.8/purecloud-api.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/q.js/1.4.1/q.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.3/FileSaver.min.js"></script>
	<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip-utils/0.0.2/jszip-utils.min.js"></script>-->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/2.1.3/js.cookie.min.js"></script>

	<script type="text/javascript">
		const cookieName = 'voicemailviewersettings';
		var environment = getParameterByName('env');
		var clientId = getParameterByName('clientId');
		var redirectUrl = window.location.href.split("?")[0];
		var settingsCookie = Cookies.get(cookieName);

		if (!settingsCookie)
			settingsCookie = {
				environment: 'mypurecloud.com',
				clientId: '3b54c857-6316-4fa9-aff1-1f56b63daff4'
			};
		else
			settingsCookie = JSON.parse(settingsCookie);

		if (environment)
			settingsCookie.environment = environment;
		else 
			environment = settingsCookie.environment;

		if (clientId)
			settingsCookie.clientId = clientId;
		else
			clientId = settingsCookie.clientId;

		Cookies.set(cookieName, settingsCookie);

		const pureCloudSession = purecloud.platform.PureCloudSession({
			timeout: 20000,
			strategy: 'implicit',
			clientId: clientId,
			//redirectUrl: 'https://mypurecloud.github.io/voicemail_viewer/index.html'
			redirectUrl: redirectUrl,
			environment: environment
		});

		const voicemailApi = new purecloud.platform.VoicemailApi(pureCloudSession);
		const usersApi = new purecloud.platform.UsersApi(pureCloudSession);
		const zip = new JSZip();

		var _me;
		var voicemails = {};

		pureCloudSession.login()
			.then(() => {
				return usersApi.getMe();
			})
			.then((me) => {
				_me = me;
				console.log(`Welcome ${me.name}`);

				$('#username').text(me.name);

				return getMessages();
			})
			.then((messages) => {
				_.forEach(messages, function(message) {
					voicemails[message.id] = message;

					// Add row
					var row = `<tr${message.read ? '' : ' class="info"'}>`;
					row += `<td class="text-center"><input type="checkbox" name="download" value="${message.id}" /></td>`;
					row += `<td class="text-center">${message.read ? '<span class="glyphicon glyphicon-eye-open" aria-hidden="true"></span>' : '<span class="glyphicon glyphicon-eye-close" aria-hidden="true"></span>'}</td>`;
					row += `<td>${message.createdDate}</td>`;
					row += `<td>${message.callerAddress}</td>`;
					row += `<td id="media-${message.id}"></td>`;
					row += '</tr>';
					$('#voicemailTable').append(row);

					// Lazy add media to row
					getMedia(message.id, 'WAV')
						.then((media) => {
							voicemails[message.id].mediaFileUri = media.mediaFileUri;
							$(`#media-${message.id}`).html(`<audio controls><source src="${media.mediaFileUri}" type="audio/webm"></audio>`);
						})
						.catch((err) => {
							console.log(err);
							alert(err);
						});
				});
			})
			.then(() => {
				console.log($(':checkbox:checked'));
			})
			.catch((err) => {
				console.log(err);
				alert(err);
			});

		function getMessages(page, aggregateResults, deferred) {
			if (!deferred)
				deferred = Q.defer();

			if (!page)
				page = 1;

			voicemailApi.getMeMessages(50, page)
				.then((results) => {
					// Aggregate results
					if (!aggregateResults)
						aggregateResults = results;
					else
						aggregateResults.entities.push.apply(aggregateResults.entities, results.entities);

					console.log(`getMeMessages returned ${results.entities.length} results, total is now ${aggregateResults.entities.length}`);

					// Done?
					if (results.selfUri !== undefined && results.selfUri == results.lastUri) {
						deferred.resolve(aggregateResults.entities);
						return;
					}

					// Get more
					page++;
					getMessages(page, aggregateResults, deferred);
				})
				.catch((err) => {
					deferred.reject(err);
				});

			return deferred.promise;
		}

		function getMedia(messageId, format, deferred) {
			if (!deferred)
				deferred = Q.defer();

			voicemailApi.getMessagesMessageIdMedia(messageId, format)
				.then((result) => {
					deferred.resolve(result);
				})
				.catch((err) => {
					deferred.reject(err);
				});

			return deferred.promise;
		}

		function toggleCheckboxes() {
			var checkboxes = $(':checkbox');
			var checked = checkboxes.length > 0 ? !checkboxes.first().prop('checked') : true;

			checkboxes.each(function(i) {
				$(this).prop('checked', checked);
			});
		}

		function downloadRecordings() {
        	// find every checked item
			$(':checkbox:checked').each(function(i) {
	            var $this = $(this);
	            var url = voicemails[$this.val()].mediaFileUri;
	            var filename = $this.val() + '.webm';
	            zip.file(filename, urlToPromise(url), {binary:true});
	            
	            /* testing plain AJAX request
	            $.ajax({
	            	url: url,
	            	crossDomain: true,
	            	success: function (data, textStatus, jqXHR) {
	            		console.log(`SUCCESS! ${url}`);
		                console.log(data);
		                console.log(textStatus);
		                console.log(jqXHR);
		            },
	            	error: function (jqXHR, textStatus, errorThrown) {
	            		console.log(`ERROR! ${url}`);
		                console.log(jqXHR);
		                console.log(textStatus);
		                console.log(errorThrown);
		            }
	            });
	            */
			});

			// when everything has been downloaded, we can trigger the dl
	        zip.generateAsync({type:"blob"}, function updateCallback(metadata) {
	            var msg = "progression : " + metadata.percent.toFixed(2) + " %";
	            if(metadata.currentFile) {
	                msg += ", current file = " + metadata.currentFile;
	            }
	            console.log(msg);
	            console.log(`Metadata percent: ${metadata.percent|0}`);
	        })
	        .then(function callback(blob) {
	        	console.log('saving zip!');
	            // see FileSaver.js
	            saveAs(blob, "voicemails.zip");
	        }, function (e) {
	        	console.log(e);
	        });
		}

		function urlToPromise(url) {
	        return new Promise(function(resolve, reject) {
	            getBinaryContent(url, function (err, data) {
	                if(err) {
	                    reject(err);
	                } else {
	                    resolve(data);
	                }
	            });
	        });
	    }

	    function getBinaryContent(path, callback) {
		    /*
		     * Here is the tricky part : getting the data.
		     * In firefox/chrome/opera/... setting the mimeType to 'text/plain; charset=x-user-defined'
		     * is enough, the result is in the standard xhr.responseText.
		     * cf https://developer.mozilla.org/En/XMLHttpRequest/Using_XMLHttpRequest#Receiving_binary_data_in_older_browsers
		     * In IE <= 9, we must use (the IE only) attribute responseBody
		     * (for binary data, its content is different from responseText).
		     * In IE 10, the 'charset=x-user-defined' trick doesn't work, only the
		     * responseType will work :
		     * http://msdn.microsoft.com/en-us/library/ie/hh673569%28v=vs.85%29.aspx#Binary_Object_upload_and_download
		     *
		     * I'd like to use jQuery to avoid this XHR madness, but it doesn't support
		     * the responseType attribute : http://bugs.jquery.com/ticket/11461
		     */
		    try {

		        var xhr = new window.XMLHttpRequest();
		        xhr.withCredentials = true;

		        xhr.open('GET', path, true);

		        // recent browsers
		        if ("responseType" in xhr) {
		            xhr.responseType = "arraybuffer";
		        }

		        // older browser
		        if(xhr.overrideMimeType) {
		            xhr.overrideMimeType("text/plain; charset=x-user-defined");
		        }

		        xhr.onreadystatechange = function(evt) {
		            var file, err;
		            // use `xhr` and not `this`... thanks IE
		            if (xhr.readyState === 4) {
		                if (xhr.status === 200 || xhr.status === 0) {
		                    file = null;
		                    err = null;
		                    try {
		                        file = JSZipUtils._getBinaryFromXHR(xhr);
		                    } catch(e) {
		                        err = new Error(e);
		                    }
		                    callback(err, file);
		                } else {
		                    callback(new Error("Ajax error for " + path + " : " + this.status + " " + this.statusText), null);
		                }
		            }
		        };

		        xhr.send();

		    } catch (e) {
		        callback(new Error(e), null);
		    }
		}

		function getRecording(voicemail) {
			var deferred = Q.defer();

			$.get(voicemail.mediaFileUri, function(data) {
				voicemail.mediaFile = data;
				deferred.resolve();
			});

			return deferred.promise;
		}

		function getParameterByName(name, url) {
			if (!url) {
				url = window.location.href;
			}
			name = name.replace(/[\[\]]/g, "\\$&");
			var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
				results = regex.exec(url);
			if (!results) return undefined;
			if (!results[2]) return '';
			return decodeURIComponent(results[2].replace(/\+/g, " "));
		}
	</script>
</head>
<body class="container-fluid">

<div class="row">
	<div class="col-md-12">
		Voicemails for <span id="username"></span>
	</div>
</div>

<div class="row">
	<div class="col-md-12">
		<table class="table table-striped" id="voicemailTable">
			<tr>
				<th class="text-center">Download? <button onclick="toggleCheckboxes()">toggle</button></th>
				<th class="text-center">Read</th>
				<th>Date</th>
				<th>Caller</th>
				<th>Playback Controls</th>
			</tr>
		</table>
	</div>
</div>

<button onclick="downloadRecordings()">Download Selected Voicemails</button>


</body>
</html>